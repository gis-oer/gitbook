# ラスタデータの分析
本教材は、「ラスタデータの分析」の実習用教材です。GISソフトウェアを用いた、ラスタデータの分析の手法について解説しています。ソフトウェアには、無償で利用できるQGISとGRASSを用いています。  
講義用教材として、[地理情報科学教育用スライド（GIScスライド）]の4章が参考になります。  

本教材を使用する際は、[利用規約]をご確認いただき、これらの条件に同意された場合にのみご利用下さい。


[地理情報科学教育用スライド（GIScスライド）]:http://curricula.csis.u-tokyo.ac.jp/slide/4.html
[利用規約]:../../../master/利用規約.md

**Menu**
------
* [数値標高モデルの変換](#数値標高モデルの変換)
* [数値標高モデルの視覚的分析](#数値標高モデルの視覚的分析)
* [基本的な統計量の確認](#基本的な統計量の確認)
* [ベクタの処理とラスタの集計の組み合わせ分析](#ベクタの処理とラスタの集計の組み合わせ分析)
* [フィルタリング](#フィルタリング)
* [ラスタ演算](#ラスタ演算)
* [流域解析](#流域解析)
* [コストパス解析](#コストパス解析)

**使用データ**
* 国土地理院
「 基盤地図情報　数値標高モデル　5ｍメッシュ　高松周辺（513440）」
* 国土交通省国土政策局「[国土数値情報]（香川県　道路データ）」を加工し、利用

[国土数値情報]:http://nlftp.mlit.go.jp/ksj/index.html

**スライド教材**  
スライドのダウンロードは[こちら]
[こちら]:../../../../raw/master/GISオープン教材/15_ラスタデータの分析/ラスタデータの分析.pptx

----------

## <a name="数値標高モデルの変換"></a>数値標高モデルの変換

[株式会社エコリスのＨＰ]から、「標高ＤＥＭデータ変換ツール」をダウンロードする。
[株式会社エコリスのＨＰ]:http://www.ecoris.co.jp/contents/ＤＥＭtool.html

### 基盤地図情報からダウンロードしたＤＥＭを変換する
![ＤＥＭを変換](pic/15pic_1.png)
ダウンロードしたＤＥＭtool.zipを解凍し、変換結合.vbsを実行する。
投影法を選択し、緯度経度を選択する。
陰影図の作成が必要な場合は、「はい」をクリックする。

![ＤＥＭを変換](pic/15pic_2.png)
基盤地図情報からダウンロードしたＤＥＭが入っているフォルダを選択し、海域の標高値を選択する（今回は-9999を選択した）。  
変換作業を開始し、完了のメッセージを待つ。  
変換元のフォルダー内に、geotifが出力されているかを確認する。  

### QGISでラスタを読み込む
![ＤＥＭを変換](pic/15pic_3.png)
ラスタの読み込みクリックして、ラスタを読み込む

### QGISでラスタを結合する
![ＤＥＭを変換](pic/15pic_4.png)
ラスタ＞その他＞結合  
入力ファイルと出力ファイルを選択し「OK」をクリックする。
データがない値に―9999を指定する。

結合したラスタを直角座標系に変換して保存する。
![ＤＥＭを変換](pic/15pic_5.png)
レイヤウインドウから、結合したラスタの上で右クリックし名前をつけて保存をクリックする。出力先、ファイル名、座標系を選択し、「OK」をクリックする。

### ラスタの切りぬき
![ラスタの切りぬき](pic/15pic_6.png)
ラスタ＞抽出＞クリッパー     
入力ラスタと出力ラスタを指定する。  
クリッピングモードの「範囲」にチェックをし、地図から切りぬきたい範囲をドラックして、「OK」をクリックする。     

![ラスタの切りぬき](pic/15pic_7.png)
ラスタの切りぬきができた。
※陸域に所々ある色が濃い部分はため池。

データがない値に、チェックをいれない、0、-9999の場合を確認する。
![値の表示](pic/15pic_8.png)

データなし値の表示方法
![値の表示](pic/15pic_9.png)
プロパティ>透過性から、データなしの値のチェックをはずして、ラスタの値の変更と表示の関係を確認しておく。

![値の表示](pic/15pic_10.png)
データがない値については、0（特定の値）、-9999、チェックを入れないという3パターンがある。
解析の目的によって、データのない値の扱いが変わる。  

[▲メニューへもどる]  
[▲メニューへもどる]:ラスタデータの分析.md#menu

## <a name="数値標高モデルの視覚的分析"></a>数値標高モデルの視覚的分析
傾斜区分図、斜面方位図、陰影図、鳥瞰図、断面図を作成する。  

### 傾斜区分図の作成
![傾斜区分図](pic/15pic_11.png)
ラスタ＞地形解析＞傾斜

![傾斜区分図](pic/15pic_12.png)
傾斜区分図が表示された。

### 斜面方位図の作成
ラスタ＞地形解析＞傾斜方位
![斜面方位図](pic/15pic_13.png)

![斜面方位図](pic/15pic_14.png)
斜面方位図が表示された。

### 陰影図の作成
![陰影図](pic/15pic_15.png)
ラスタ＞地形解析＞陰影図

![陰影図](pic/15pic_16.png)
陰影図が表示された。  
陰影図の元にしたラスタを重ねて、透過率を設定することで標高の表現ができる。

### 鳥瞰図の作成
![鳥瞰図](pic/15pic_17.png)
プラグイン＞プラグインの管理とインストール  
Qgis2threejsをインストールする。

OpenLayers pluginから、OpenStreetMapを読み込んでおく。
※インストールしていない場合は、「プラグインの管理とインストール」からインストールする。
![鳥瞰図](pic/15pic_18.png)
Web(W)＞OpenLayers plugin＞OpenStreetMap＞OpenStreetMap

![鳥瞰図](pic/15pic_19.png)
ＤＥＭ layer にＤＥＭを選択し、Display typeのMap canvas image にチェックをいれ、「Run」をクリックする。

![鳥瞰図](pic/15pic_20.png)
ブラウザが立ち上がり、鳥瞰図が表示される。

![鳥瞰図](pic/15pic_21.png)
国土地理院の国土情報画像を読み込むこともできる。（タイルレイヤプラグインを利用）

### GRASSで鳥瞰図
![鳥瞰図](pic/15pic_22.png)
GRASSでＤＥＭを読み込み表示を3Dにすると立体表現がされる。

### 断面図の作成
![断面図](pic/15pic_22-1.png)
プラグインの管理とインストールからProfile tool をインストールする。  

![断面図](pic/15pic_22-2.png)
プラグイン>Profile tool から起動し、図上で任意の点を選択する（1点以上選択後ダブルクリックする。選択を解除したい場合は、右クリックする）。別ウィンドウに断面形が表示される。  


[▲メニューへもどる]  

## 基本的な統計量の確認
![基本統計量](pic/15pic_23.png)
ラスタ＞その他＞情報  
最低標高、最高標高、平均標高、標高の標準偏差が確認できる。

![基本統計量](pic/15pic_24.png)
プロパティからも確認できる。

[▲メニューへもどる]  

## ベクタの処理とラスタの集計の組み合わせ分析
道路と周辺の標高値を計算する。
![ベクタの処理とラスタの集計](pic/15pic_25.png)
国土数値情報から香川県のデータをダウンロードし、50mのバッファを作成する。

![ベクタの処理とラスタの集計](pic/15pic_26.png)
ラスタ＞地域統計（Ｚ）＞地域統計（Ｚ）
地域統計を計算する各ライン周辺の最大標高、最小標高、平均標高などを計算する。

![ベクタの処理とラスタの集計](pic/15pic_27.png)
属性テーブルを開き、最大標高、最小標高、平均標高など計算結果を確認する。

![ベクタの処理とラスタの集計](pic/15pic_28.png)
属性テーブルから選択し、地図で位置を確認する。

[▲メニューへもどる]  

## フィルタリング
![ふるい](pic/15pic_29.png)
ラスタ＞解析＞ふるい
入力ファイルと出力ファイルを指定し、ピクセルの連結値を選択して、「OK」をクリックする。

![ふるい](pic/15pic_30.png)
プロパティから、値が変わっていることを確認する。

![ふるい](pic/15pic_31.png)
ふるいありとなしでは、数値の表示が変化する。
※プロパティの一般情報から、セル数の変化がないことを確認しておく

[▲メニューへもどる]  

## ラスタ演算
※ＤＥＭと傾斜区分図を読み込んでおく。
![ラスタ演算](pic/15pic_32.png)
ラスタ＞ラスタ計算機
計算結果を出力するための新規ラスタを作成する。

![ラスタ演算](pic/15pic_33.png)
ＤＥＭから標高150ｍ以上の地域を抽出する。

````
 ( "標高ラスタ@1"  >=  150 )   
````

![ラスタ演算](pic/15pic_34.png)

````
 ( "標高ラスタ@1"  >=  150 )  AND  ( "傾斜ラスタ@1" <= 10  )   
````

ＤＥＭから標高150m以上で傾斜が10度以下の地域を抽出する。


[▲メニューへもどる]  

## 流域解析
![流域解析](pic/15pic_35.png)
GRASSのプラグンインを利用して、ラスタ解析を行う。  

![流域解析](pic/15pic_36.png)
GRASSで新規マップセットを作成する。
> マップセットの作成は、[GRASSビギナーズマニュアル](../GRASSビギナーズマニュアル/GRASSビギナーズマニュアル.md)を参照

![流域解析](pic/15pic_37.png)
マップセットに標高ラスタデータを読み込む。

![流域解析](pic/15pic_38.png)
モジュールリストタブに切り替え、ラスタの範囲を設定する（フィルターから、g.region.zoomを検索する）。

![流域解析](pic/15pic_39.png)
モジュールツリータブに切り替え、ラスタ＞空間モデル＞水理モデル＞流域解析（r.watershedを検索しても良い）を選択する。  
入力ラスタにＤＥＭを指定し、流域の最小サイズを入力する。  
出力するファイル名をそれぞれの項目ごとに入力し実行する。  
「出力を見る」をクリックする。  

![流域解析](pic/15pic_40.png)

![流域解析](pic/15pic_41.png)
流域と河川のラスタをベクトルに変換する。
ラインに出力できるように河川のラスタを単純化する(r.thinを検索し、実行する)。

![流域解析](pic/15pic_42.png)
ファイル管理＞地図の型変換＞GRASSを利用してラスタをベクタに変換します、からラスタをベクタラインに変換する(r.to.vect.lineを検索し、実行する)を実行する。  

![流域解析](pic/15pic_43.png)

![流域解析](pic/15pic_44.png)
ファイル管理＞地図の型変換＞GRASSを利用してラスタをベクタに変換します、からラスタをベクタエリアに変換する(r.to.vect.areaを検索し、実行する)。  

![流域解析](pic/15pic_45.png)

![流域解析](pic/15pic_46.png)
流域が抽出できた。

![流域解析](pic/15pic_47.png)
GRASSで出力したベクトルを、外部に出力する。

[▲メニューへもどる]  

## 河川ごとに流域をグルーピング
![流域解析](pic/15pic_48.png)
河川の属性で流域を分類できないため、分類できる属性値をつくる。  
河川から数mのバッファを引く（今回は5mとした）。

![流域解析](pic/15pic_49.png)
バッファが、マルチパートになっているため（属性テーブルを確認）、シングルパートへ変換する（河川ごとに分割される）。

![流域解析](pic/15pic_50.png)
河川ごとに分割されていることを選択機能で確認する。

![流域解析](pic/15pic_51.png)
フィールドを追加し、河川ごとに固有のIDを振り分ける。  
変種モードから、フィールド計算機を起動し、新規にフィールドを作成する。  
出力フィールド名を追加し、タイプをintegerにする。  
関数→レコード→idで、IDを振り分ける。  

![流域解析](pic/15pic_52.png)
ＩＤが振り分けられたことを確認し、余分なフィールドを削除しておく。
編集を保存し、編集モードを終わらせておく。

![流域解析](pic/15pic_53.png)
河川ラインに、bufferに追加した固有値を空間結合する。

![流域解析](pic/15pic_54.png)
流域ポリゴンに、bufferに追加した固有値を空間結合する。

![流域解析](pic/15pic_55.png)
河川ごとに流域が表示できた。

[▲メニューへもどる]  

## コストパス解析
※　GRASSを立ち上げて、QGISで作成したマップセットを読み込んでおく。
![コストパス解析](pic/15pic_56.png)
ラスター＞地形解析＞斜面と方位  
斜面方位図と傾斜区分図をマップセット内に作成する。  
入力ラスターにＤＥＭを選択し、タブを切り替えて出力ファイルを入力し「実行」をクリックする。

### 傾斜をもとに移動コストを算出する
![コストパス解析](pic/15pic_57.png)
ラスター＞地形解析＞移動コスト積算
入力ラスタにＤＥＭを選択し、フリクションコストを含むラスタに傾斜ラスタを選択する。出力ラスタ名を入力する。

![コストパス解析](pic/15pic_58.png)
タブを切り替えスタートと停止の座標を入力する。  
カーソルボタン（赤枠）をクリックし、地図から任意の場所をクリック

![コストパス解析](pic/15pic_59.png)
ラスター＞地形解析＞最小コストルートあるいはフロー  
移動コストをもとに、任意の2点間の最短経路を検索する。  
入力ファイルに移動コストのラスタを選択し、出力ファイルを指定する。
スタートタブに切り替え、　　カーソルボタンを使って、地図から任意の地点を選択し、「実行」をクリックする。

![コストパス解析](pic/15pic_60.png)
任意の2点間で傾斜に基づく最短経路が検索できた。

[▲メニューへもどる]  

**その他のライセンス**  
本教材で利用しているキャプチャ画像の出典やクレジットについては、[その他のライセンスについて]よりご確認ください。
[その他のライセンスについて]:../その他のライセンスについて.md
