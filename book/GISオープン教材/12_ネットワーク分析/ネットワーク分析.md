# ネットワーク分析
本教材は、「ネットワーク分析」の実習用教材です。GISソフトウェアを用いた、最短経路検索や到達圏検索の手法について解説しています。ソフトウェアには、無償で利用できるQGISとGRASSを用いています。  
講義用教材として、[地理情報科学教育用スライド（GIScスライド）]の4章が参考になります。  

本教材を使用する際は、[利用規約]をご確認いただき、これらの条件に同意された場合にのみご利用下さい。


[地理情報科学教育用スライド（GIScスライド）]:http://curricula.csis.u-tokyo.ac.jp/slide/4.html
[利用規約]:../../../master/利用規約.md

**Menu**
------
* [最短距離検索](#最短距離検索)：QGIS
* [ネットの分割](#ネットの分割)：QGIS+GRASS
* [NetworkAnalystToolを用いた分析](#NetworkAnalystToolを用いた分析)：GRASS

**使用データ**
* 「国土交通省国土政策局「[国土数値情報]（島根県　行政区域、道路、消防署、医療施設データ）」を加工し（座標変換EPSG:2445 ）、利用」

[国土数値情報]:http://nlftp.mlit.go.jp/ksj/index.html

**スライド教材**  
スライドのダウンロードは[こちら]
[こちら]:../../../../raw/master/GISオープン教材/12_ネットワーク分析/ネットワーク分析.pptx
----------

## 最短経路検索
QGISの道路グラフプラグインを使用して、2点間の最短距離を求める
![最短経路検索](pic/12pic_1.png)  
国土数値情報からダウンロードした道路データを読み込む。

![最短経路検索](pic/12pic_2.png)  
ベクタ＞道路グラフ＞設定  
道路グラフプラグインの設定を行う。

![最短経路検索](pic/12pic_3.png)  
時間単位、距離単位を選択し輸送レイヤをroad（ラインデータ）に設定する。  
タブをデフォルト設定に切り替えスピードを入力（60km/h）。

![最短経路検索](pic/12pic_4.png)  
アイコンの表示されていな部分で右クリックすると、プラグインの切り替えウインドウが表示される。  
最短経路にチェックをいれる。

![最短経路検索](pic/12pic_5.png)  
表示されている道路を基準にして、経路を検索したい二点の場所をクリック。　　
最短経路を表示するウインドウに検索結果が表示される。  
経路を消したい場合は、クリアをクリックする。  

[▲メニューへもどる]  
[▲メニューへもどる]:ネットワーク分析.md#menu

## ネットの分割
QGISとGRASSでネットの分割を行う。  
GRASSでshapeファイルを読み込むための準備を行うため、新規マップセットをクリック。　　
データベースを保存するディレクトリを選択する（あらかじめ空のフォルダを作っておくと良い）。
![ネットの分割](pic/12pic_6.png)  

![ネットの分割](pic/12pic_7.png)  
新しいロケーション名を任意で入力し、座標系を選択する。

![ネットの分割](pic/12pic_8.png)  
現在のQGISの範囲を設定をクリックし、新規マップセット名を入力する。

![ネットの分割](pic/12pic_9.png)  
新規マップセットの作成が完了した。

![ネットの分割](pic/12pic_10.png)  
GRASSツールをクリックする。モジュールリストのタブに切り替え、フィルターにv.inと入力しロードされたベクタをインポートする(v.in.ogr.qgis) を選択し、shapeファイルを読み込む。

![ネットの分割](pic/12pic_11.png)  
タブを切り替え、ロードされたレイヤ（QGISで読み込んでいるshapeファイル）からGRASSで読み込みたいデータを選択する。
出力するベクトルマップ名を入力し、実行をクリックする。

![ネットの分割](pic/12pic_12.png)  
同様の作業を繰り返し、データを読み込む。  
データの読みが一通りできたら、タブをブラウザに切り替え、データが読み込まれていることを確認する。

![ネットの分割](pic/12pic_13.png)  
表示したいデータを右クリックし、選択した地図をキャンバスに追加 する。  
※データが重複するためQGISのデータは消しておく。

![ネットの分割](pic/12pic_14.png)  
同様の手順を繰り返し、データを表示する。

### グラフを作成する
ラインとポイントが重ならない別のデータであるため、ネットワーク分析ができるようにデータを加工する。
![グラフを作成](pic/12pic_15.png)  

![グラフを作成](pic/12pic_16.png)  
GRASSツールを開き、モジュールツリーにタブを切り替える。
ネットワークメンテナンスをクリックし、タブを切り替えラインデータとポイントデータを選択する。
実行するオペレーションをconnectにして、出力するベクトルマップ名を入力し、実行をクリック。

![グラフを作成](pic/12pic_17.png)  
ブラウザタブに切り替え、作成したデータを表示する。

![グラフを作成](pic/12pic_18.png)  
ラインがポイントまでつながるようになり、ネットワーク分析ができるようになった。

### 到達圏の検索をする
![到達圏の検索](pic/12pic_19.png)  
GRASSツールを開き、モジュールツリーにタブを切り替える。　　
ネットワークを等費線で切断する をクリックする。

![到達圏の検索](pic/12pic_20.png)  
作成したデータを選択する。　　
等値線のコストをｍで入力し、出力するベクトルマップ名 を入力する。

![到達圏の検索](pic/12pic_21.png)  
ブラウザタブに切り替え、作成したデータを表示する。

![到達圏の検索](pic/12pic_22.png)  
プロパティからスタイルを変更する。  
等値線で入力した値ごとに色分けをする。

![到達圏の検索](pic/12pic_23.png)  
道路距離に基づく到達圏が表示できた。

[▲メニューへもどる]  

## NetworkAnalystToolを用いた分析
GRASSのみを利用するときの、データの格納と読み込みの仕方は、[GRASSビギナーズマニュアル]を参照。
[GRASSビギナーズマニュアル]:../GRASSビギナーズマニュアル/GRASSビギナーズマニュアル.md

Vector Network Analyst Tool を利用する。
作成したグラフを選択しておく。
![NetworkAnalystTool](pic/12pic_24.png)  
ベクタ＞ネットワーク解析＞Vector Network Analyst Tool

### コストを追加する
![コストを追加](pic/12pic_25.png)  
Input tables タブに切り替え、ウインドウを拡大し属性テーブルを表示する。
属性テーブルを編集して、コストを追加していく。

![コストを追加](pic/12pic_26.png)  
フィール名の上で右クリックして、列の追加をする。
列名を入力し、データ型を選択する。

### 線の長さを追加する
![コストを追加](pic/12pic_27.png)  
新規に作成したフィールドの上で右クリックし、計算（数値カラムのみ） →ライン長を選択する。
空のフィールドに、ラインの長さが計算され、追加される。

### 速度を追加する
![速度を追加](pic/12pic_28.png)  
フィール名の上で右クリックして、列の追加をする。
列名を入力し、データ型を選択する。

![速度を追加](pic/12pic_29.png)  
Constraint for query (WHERE clause)にチェックを入れる。
検索ウィンドウに式を入力する。

![速度を追加](pic/12pic_30.png)  
UPDATE データ名 SET 計算したいフィールド名 = 入力したい値(80km/h)  WHERE 分類に用いるフィールド = 分類に基づく値

今回の場合は、N01_001のフィールドにある1-3の値に応じて、速度を分類して計算している。
N01_001列で１の値を持つフィールドと同じ行にあるspeed（新規の列）の値を80km/hとしている。

※列、値ウインドウの表示をクリックすると検索ウインドウに入力される。

![速度を追加](pic/12pic_31.png)  
N01_001列で１の値を持つフィールドと同じ行にあるspeed（新規の列）の値が80km/hとなった。

![速度を追加](pic/12pic_32.png)  
N01_001の2と3の値と同じ行のspeed列の速度も計算する

### 時間を追加する
![時間を追加](pic/12pic_33.png)  
time列とコスト列をcost列を新規に追加する

![時間を追加](pic/12pic_34.png)  
長さ÷スピード×60　＝時間
time列とcost列を計算する

![時間を追加](pic/12pic_35.png)  
コストが追加された。

### ワークスペースの保存
![ワークスペースの保存](pic/12pic_36.png)  
ワークスペースを保存しておくことで、作業の途中経過を保存することができる。
入力したデータそのもの変化せず、表示範囲や色分けなどが保存される。

### カラー調整
![カラー調整](pic/12pic_37.png)  
ベクトル＞カラー調整＞Manage color rules interactively  
速度ごとに道路を色分けする。  
注意が出るが はい をクリックする。  
※重たい処理になるのでPCがフリーズする可能性あり。

![カラー調整](pic/12pic_38.png)  
Use color column instead of color table: にチェックを入れ、列を追加をクリックし、OKをクリック

![カラー調整](pic/12pic_39.png)  
データの上で右クリックし、属性データを表示 をクリックする。

![カラー調整](pic/12pic_40.png)  
GRASSRGBという列ができている。この列で色を指定する。

![カラー調整](pic/12pic_41.png)  
まず、全データを赤色にしてみる。  
新規の列の全フィールドを ’255:0:0’ にする。

![カラー調整](pic/12pic_42.png)  
ベクトル＞カラー調整＞Manage color rules interactively
Use color column instead of color table: にチェックを入れ、適用、OKをクリックすると色が変わる。

![カラー調整](pic/12pic_43.png)  
同様の手法で、速度ごとの色分けもできる（エラーがでるが表示される）。

### Vector Network Analysis Tool について
![Vector Network Analysis Tool](pic/12pic_44.png)  
パラメータータブをクリックし、分析したいデータを選択しておく。

![Vector Network Analysis Tool](pic/12pic_45.png)  
分析手法を選択し、Points タブをクリックする。

![Vector Network Analysis Tool](pic/12pic_46.png)  
ポイントのタイプを選択し（分析手法によって異なる）、地図が表示されているウインドウを開く。
地図ウインドウを利用して、ポイントを移動させ、始点と終点の位置を決める。

![Vector Network Analysis Tool](pic/12pic_47.png)  
ポイントの位置が決まったら、赤枠の右向き三角ボタンをクリックする。最短経路の検索が始まる。

### コスト値を追加する
![コスト値を追加する](pic/12pic_48.png)  

![コスト値を追加する](pic/12pic_49.png)  
最短経路検索・・・ネットワークの最短経路を検索する  
巡回セールスマン問題・・・条件づけをした経路検索  
最大流量・・・ネットワーク上にある2セットのノード間の最大フローを計算する  
サブネット設定・・・最も近接する中心点からサブネットを配分する（時間や距離によるネットの分割が可能）  
フィーチャー間の最短経路・・・所与のフィーチャーセット間のネットワークを経由する最短経路を計算  
ネットの分割・・・コスト値によってネットを分割  

### 最短経路検索
![最短経路検索](pic/12pic_50.png)  
コスト値なしで最短経路の検索をする。

![最短経路検索](pic/12pic_51.png)  
同じ地点で、コスト値を設定して、最短経路の検索をする。
コスト値ありとなしでは、検索結果が変化する。

### 巡回セールスマン問題
![巡回セールスマン](pic/12pic_52.png)  
ポイントを追加して、巡回に適した最短経路を検索する。

### サブネット設定
![サブネット設定](pic/12pic_53.png)  
ポイントを中心としたネットワーク圏を検索する。

### ネットの分割
![サブネット設定](pic/12pic_54.png)  
ポイントを中心に指定した距離ごとにネットを分割する。  
Iso lines: で距離を設定する。

[▲メニューへもどる]  

**その他のライセンス**  
本教材で利用しているキャプチャ画像の出典やクレジットについては、[その他のライセンスについて]よりご確認ください。
[その他のライセンスについて]:../その他のライセンスについて.md
