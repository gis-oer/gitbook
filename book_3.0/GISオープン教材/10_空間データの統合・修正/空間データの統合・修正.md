
# 空間データの統合・修正
　本教材は、「空間データの統合・修正」の実習用教材です。GISで用いられるラスタデータ（以下、ラスタという）とベクトルデータ（以下、ベクタという）の統合、修正、変換などデータの編集手法について解説しています。ソフトウェアには、無償で利用できるQGISを用いています。

　課題形式で使用する場合は、本教材を一読した後、[課題ページ]へお進みください。GIS初学者は、本教材を進める前に[GISの基本概念]の教材を確認しておいてください。本教材を使用する際は、[利用規約]をご確認いただき、これらの条件に同意された場合にのみご利用下さい。

**Menu**
---------
* [ラスタのモザイクとクリップ](#ラスタのモザイクとクリップ)
* [等高線の抽出](#等高線の抽出)
* [ラスタをベクタへ](#ラスタをベクタへ)
* [新規ベクタの作成](#新規ベクタの作成)
* [ベクタの修正](#ベクタの修正)
* [ベクタをラスタへ](#ベクタをラスタへ)

**使用データ**
[既存データの地図データと属性データ]教材と[ラスタデータの分析]教材を参考に、以下のデータのダウロードおよび変換を行ってください。

* 国土地理院　[基盤地図情報]　基本項目　石巻周辺（574142、574143、574152、574153）
* 国土地理院　[基盤地図情報]　数値標高モデル　5ｍメッシュ　石巻周辺（574142、574152）

* 国土交通省国土政策局「[国土数値情報]（宮城県　郵便局データ）」を加工し、利用

* [地理院タイル]（国土地理院）
>地理院タイルの利用は、[QGISビギナーズマニュアル:TileLayerPluginのインストール]の教材を参照。

**スライド教材**
スライドのダウンロードは[こちら](../../../../raw/master/GISオープン教材/10_空間データの統合・修正/空間データの結合・修正.pptx)

------

## ラスタのモザイクとクリップ
　以下では、[基盤地図情報]からダウンロードした5mDEMを用いて、ラスタデータの結合と任意範囲での切り抜きの解説を行っています。DEMは、Digital Elevation Modelの略であり、各セルごとに標高値を保持しるデータです。以下に従って、ダウンロードしたデータから任意地域からデータの切り出しを試してください。

ラスタを読み込むボタンをクリックして、変換したラスタを全て読み込む。
![ラスタ](pic/10pic_1.png)


### ラスタのモザイク
ダウンロードした複数のラスタを一つにまとめる（モザイク）。
![モザイク](pic/10pic_2.png)
ラスタ＞その他＞結合
① 入力ファイルを選択する。
② 出力先とファイル入力する。
③ ＯＫをクリックする。

＊データがない値を0とせずにNULL値（データ無し）として扱いたい場合は、-9999を設定する。
プロパティ＞透過性からデータ無しとする値に-9999を設定

以下のようにラスタが結合できる。
![モザイク](pic/10pic_3.png)

このデータの場合、ラスタのセルごとに標高値を保持しているため、標高値による色分けができる。
![配色](pic/10pic_3-1.png)
①　プロパティ ＞ スタイルから、レイヤタイプを単バンド疑似カラーにする。
②　新規カラーマップを作成から等間隔モードにし、分類数と配色を設定し、「分類」をクリックする。
③　各値上でクリックを行い分類数に応じて値を書き換える（ラベルも書き換える）。
④　適用をクリックし、配色を確認後OKをクリックする。

以下のように、標高値ごとに色わけができた。
![モザイク](pic/10pic_4.png)

### ラスタのクリップ
対象範囲の切り取りを行う。
![クリップ](pic/10pic_5.png)
ラスタ＞抽出＞クリッパー
① 入力ファイルを選択する。
② 出力先とファイル入力する。
③ 地図から切り抜きたい範囲を選択する。
④ ＯＫをクリックする。

＊データがない値を0とせずにNULL値として扱いたい場合は、-9999を設定する。
プロパティ＞透過性からデータ無しとする値に-9999を設定

ラスタが切り抜けた後、切り抜いたラスタの配色を変更する。
![クリップ](pic/10pic_6.png)

### ラスタの座標変換
ラスタの座標変換が必要な場合は、以下のように行う。詳しくは、[ラスタデータの分析]で解説している。
![座標変換](pic/10pic_9-1.png)
ラスタ＞投影法＞ワープを選択し、上のように値を設定し、OKをクリックする。

[▲メニューへもどる]

## 等高線の抽出
　作成したラスタデータは、各セルごとに標高値を保持しているため値を用いて、等高線を作成することができる。以下では、等高線を作成する手法について解説しています。

切り抜いたラスタを利用して、等高線を作成する。
![等高線の抽出](pic/10pic_7.png)
ラスタ＞抽出＞等高線　　
① 入力ファイルを選択する。
② 出力先とファイル入力する。
③ 等高線の間隔を入力（単位はｍ）する。
④ チェックを入れる
⑤ ＯＫをクリックする。

等高線は任意に指定した間隔で作成できる。例として、1mと5mの等高線を作成してみる。
![等高線の抽出](pic/10pic_8.png)

以下のように、1mと5mの等高線が出力された。
![等高線の抽出](pic/10pic_9.png)

[▲メニューへもどる]

## ラスタをベクタへ
　GISでは、処理の内容やデータの表現のため、ラスタデータやベクタデータを使い分けて使用します。以下では、ラスターデータをベクタデータに変換する手法について解説しています。

ラスタをベクターに変換する。
![ラスタをベクタへ](pic/10pic_10.png)
ラスタ＞変換＞ポリゴン化（ラスタのベクタ化）
① 入力ファイルを選択する。
② 出力先とファイル入力する。
③ チェックを入れる。
④ ＯＫをクリックする。

下の図のように、ラスタがベクタに変換できた。
![ラスタをベクタへ](pic/10pic_11.png)


### ポリゴンから特定の値（例：10m以上の地域）を表示する場合
作成したポリゴンから、特定の値の地域の抽出をする場合、以下のように行う。
![ラスタをベクタへ](pic/10pic_12.png)
プロパティ>スタイル
「段階に分けられた」を選択し、カラムに「DN」値を指定する。
分類数を1にし、「分類」をクリックする。値をクリックし10-最大値を入力し、OKをクリックする。

[▲メニューへもどる]

## 新規ベクタの作成
　GISでは、第3者が作成した既存のデータだけでなく、自作したデータを作成や解析等をすることができます。以下では、新規にベクトルデータを作成する手法について解説しています。

新規にベクトルデータを作成する。
![テーブルを編集](pic/10pic_20-1.png)
①　レイヤ＞レイヤの作成＞新規シェープファイルレイヤを選択する。
②　作成したいレイヤのタイプを点，ライン，ポリゴンから選択する。
③　エンコーディングと座標系を設定する。
④　新規ポイントに追加したい属性を「新しい属性」から設定する。
「名称」はカラム名、「タイプ」はデータ型にあわせる、「幅」と「精度」は入力するデータによる。
「タイプ」・・・値が整数ならInteger、小数を含むならReal、テキストならStringとなる。
「幅」＞桁数、「精度」＞表示する小数の位
（上の画像のように標高値を設定すると、幅が4桁で小数第3位まで表示するため、9.999以上の値が入力できなくなる）
⑤　OKを押し保存先を選択する。

※新規ベクタ作成では、ポイント、ライン、ポリゴンを同時に作成することができない。各レイヤを作成する場合ごとに、新規レイヤ作成が必要となる。


下の図の赤枠の編集モード切替アイコンから、編集モードをオンにして任意の場所でクリックする（ポリゴンやラインの追加は、最後に右クリックし閉じる）。ポイント等の追加や削除は、青枠のボタンを利用する。
地物属性を入力するウィンドウが立ち上がるため、各項目に値を入力する。
OKをクリックするとポイントが作成される。ポイントの追加が完了したら、編集モード切替アイコンをクリックし、編集を保存する。
![テーブルを編集](pic/10pic_20-2.png)


## ベクタの修正
　GISでは、既存のデータを編集することができます。地物の位置が実際とは異なっている場合や解析用に属性を編集したい場合などに、既存データを改変することがあります。以下では、ベクトルデータの修正について解説しています。

### ベクタの修正 ①ポイント
以下では、ある地点のポイントが実際の位置とは異なっていると仮定して、位置を修正する手法について解説しています。[国土数値情報]から宮城県の郵便局のデータをダウンロードし、QGISでデータを読み込んでください。

※実際には、座標変換が必要となる場合がありますが、今回はデータ編集の練習のため変換は必須ではありません。右下のEPSGと書かれたボタンから、「オンザフライCRS変換を有効にする」をチェックしておいてください。

QGISで国土数値情報でダウンロードした宮城県の郵便局のデータを読み込み、背景地図に地理院地図を利用（タイルレイヤプラグイン）する。

![ラスタをベクタへ](pic/10pic_13.png)


#### ポイントの削除
以下では、石巻門脇郵便局と石巻中央郵便局のポイントを利用し解説をしていますが、データの範囲内であればどのポイントを使用してもかまいません。

まず、ベクタ編集の練習としてポイントの削除を行う。
![ポイントの削除](pic/10pic_14.png)
① 編集したいレイヤを選択する。
② 編集モードをクリックする。
③ 地物の選択をクリックする。
④ 消したいポイントをクリックする。
※編集が終わったら編集の保存ボタンををクリックして一時保存する。

ポイントが削除できた。
![ポイントの削除](pic/10pic_15.png)

#### ポイントの移動
次に、ベクタ編集の練習としてポイントの移動を行う。
![ポイントの移動](pic/10pic_16.png)
① 編集したいレイヤを選択する。
② 編集モードであることを確認する。
③ 地物の移動をクリックする。
④ ポイントを動かす。
※編集が終わったら編集の保存ボタンををクリックして一時保存する。

ポイントが移動できた。
![ポイントの移動](pic/10pic_17.png)


#### ポイントの追加
最後に、ベクタ編集の練習としてポイントの追加を行う。
![ポイントの追加](pic/10pic_18.png)
① 編集したいレイヤを選択する。
② 編集モードであることを確認する。
③ ポイントの追加をクリックする。
④ 追加したい地点をクリックする。
⑤ 値を入力し、ＯＫをクリックする。※　属性テーブルを参考にする

#### 属性テーブルを編集する
属性情報を編集する場合は、以下のように行う。
![テーブルを編集](pic/10pic_19.png)
① 編集したいレイヤを選択する。
② 編集モードであることを確認する。
③ 属性テーブルを開く。
④ テーブルを編集する。
※編集が終わったら編集の保存ボタンををクリックして一時保存する。

編集が完了したらたら編集ボタン(下の図の左上赤枠)をクリックすると編集モードが終了する。
※メッセージが出る場合は、保存をクリックする。
![テーブルを編集](pic/10pic_20.png)


### ベクタの修正 ②ラインとポリゴン
以下では、ラインとポリゴンの編集について解説しています。以下を試す前に、新規ベクタの作成を参考に任意の形のポリゴンを新規作成して下さい。ラインは、基盤地図情報から石巻市周辺の水涯線をダウンロードしてください。

#### ポリゴンの修正
新規に作成したポリゴンを利用し、形状の編集を行う。
![ポリゴンの修正](pic/10pic_21.png)

以下のように、形状を変更する。
![ポリゴンの修正](pic/10pic_22.png)
① 編集したいレイヤを選択する。
② 編集モードをクリックする。
③ ノードツールをクリックする。
④ 頂点を編集する。

頂点を移動するとポリゴンの形状が変わり、線上でダブルクリックすると頂点が増える。
![ポリゴンの修正](pic/10pic_23.png)


#### 新規ポリゴンを連結させる
　ポリゴンやラインを連結させる場合には、そのラインやポリゴンを構成する頂点を重ねる必要があります。以下は、見た目で重ねた結果ですが実際には重なっていないことが確認できます。

ポリゴンの作成ボタンをクリックし、新しいポリゴンを作成する。
![新規ポリゴンを連結](pic/10pic_24.png)

連結させるようにポリゴン同士の頂点を重ねる。
![新規ポリゴンを連結](pic/10pic_25.png)

下の図は連結しているようにみえるが、拡大すると連結していないことが確認できる。
![新規ポリゴンを連結](pic/10pic_26.png)
※この方法では、ポリゴンを連結することはできない。

#### 頂点の重ね合わせ
　以下では、万石浦に橋を建設することを仮定して、QGISで頂点を重ねる手法について解説しています。基盤地図情報からダウンロードした石巻周辺の水涯線のデータを利用しています。

QGISで基盤地図情報からダウンロードした石巻市のデータを読み、頂点の連結を確認する。
編集したいレイヤを選択し、ノードツールをクリックする（編集モードをオンにしておく）。
![頂点の重ね合わせ](pic/10pic_27.png)

編集モードで、頂点を移動する（保存はしない）。
ラインやポリゴンは頂点でつながっている。
![頂点の重ね合わせ](pic/10pic_28.png)

スナップオプションの設定を変えて、頂点に重ねられるようにする。
![頂点の重ね合わせ](pic/10pic_29.png)
設定＞スナップオプション
①　編集したいレイヤにチェックを入れる。
②　頂点と線分を選択する。
③　許容範囲を入力（今回は20）する。

#### ラインと頂点の編集（万石浦に橋を作成）
新規のラインを作成し、万石浦に橋を作成していく。
![新規レイヤ](pic/10pic_30.png)
レイヤ＞新規シェープファイルレイヤ
① ラインを選択する。
② エンコーディングを選択する。
③ ＣＲＳを選択する。
④ ＯＫをクリックする。
⑤ 出力先とファイル名を入力し保存する。
※今回は、属性を追加しない。

新規のラインが追加された。
プロパティからスタイルを変更する。
![新規レイヤ](pic/10pic_31.png)


#### ラインのレイヤを新規に作成する
ラインの頂点を連結させ、万石浦に橋（ライン）を作成する。
![橋のレイヤ](pic/10pic_32.png)

編集モードで、水涯線にカーソルをあてるとカーソルの色が変化する。
![橋のレイヤ](pic/10pic_33.png)

編集が完了したらたら編集ボタンをクリックすると編集モードが終了する。
※メッセージが出る場合は、保存をクリックする。
![橋のレイヤ](pic/10pic_34.png)

頂点が重なっていることが確認できる。
![橋のレイヤ](pic/10pic_35.png)


[▲メニューへもどる]

## ベクタをラスタへ
　GISでは、処理の内容やデータの表現のため、ラスタデータやベクタデータを使い分けて使用します。以下では、石巻市周辺の水域ポリゴンをラスタへ変換する手法について解説しています。また、以下ではラスタ変換用に加工した水域ポリゴンを使用しています。水域ポリゴンの作成は、中級者向けになるので、初級者は以下の教材が難しい可能性があります。

ラスタ変換用に、加工した主な水域ごとに値を分類したポリゴンを作成する。
![ベクタをラスタへ](pic/10pic_36.png)
→属性テーブルを整理し、1列にしておく。
→選択して水域ごとに値を入れる。
→シングルパートをマルチパートにする。

ベクタをラスタに変換する。
![ベクタをラスタへ](pic/10pic_37.png)
ラスタ＞変換＞ラスタ化（ベクタのラスタ化）
① ベクタを選択する。
② 色分けに使う、属性フィールドを選択する。
③ 出力先とファイル名を入力する。
④ チェックする。
⑤ ＯＫをクリックする。

水域ポリゴン（ベクタ）がラスタに変換された。
![ベクタをラスタへ](pic/10pic_38.png)


色分けすると主な水域ごとに色分けができる。
拡大するとラスタであることが確認できる。
![ベクタをラスタへ](pic/10pic_39.png)


[▲メニューへもどる]

#### この教材の[課題ページ]へ進む

#### ライセンスに関する注意事項
本教材で利用しているキャプチャ画像の出典やクレジットについては、[その他のライセンスについて]よりご確認ください。

[その他のライセンスについて]:../その他のライセンスについて.md
[ラスタデータの分析]:../15_ラスタデータの分析/ラスタデータの分析.md
[QGISビギナーズマニュアル]:../QGISビギナーズマニュアル/QGISビギナーズマニュアル.md
[既存データの地図データと属性データ]:../07_既存データの地図データと属性データ/既存データの地図データと属性データ.md
[基盤地図情報]:http://www.gsi.go.jp/kiban/
[国土数値情報]:http://nlftp.mlit.go.jp/ksj/index.html
[地理院タイル]:http://maps.gsi.go.jp/development/ichiran.html
[課題ページ]:../課題/課題ページ/空間データの統合・修正.md
[地理情報科学教育用スライド（GIScスライド）]:http://curricula.csis.u-tokyo.ac.jp/slide/3.html
[利用規約]:../../../master/利用規約.md
[GISの基本概念]:../01_GISの基本概念/GISの基本概念.md
[QGISビギナーズマニュアル:TileLayerPluginのインストール]:../QGISビギナーズマニュアル/QGISビギナーズマニュアル.md#tilelayerpluginのインストール
[▲メニューへもどる]:空間データの統合・修正.md#menu
